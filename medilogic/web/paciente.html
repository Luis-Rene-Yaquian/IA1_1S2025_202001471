<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Paciente</title>
  <style>
    :root{
      --fg:#0f172a; --muted:#64748b; --line:#e2e8f0; --bg:#f7f9ff; --card:#fff; --blue:#3b82f6;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px;background:var(--bg);color:var(--fg)}
    .wrap{max-width:1000px;margin:auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .box{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;vertical-align:middle}
    th{font-weight:600}
    .btn{padding:10px 14px;border:1px solid #94a3b8;border-radius:10px;background:#fff;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    textarea,input,select{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px}
    #chart{width:100%;height:240px;border:1px dashed #cbd5e1;border-radius:8px;background:#fff}
    .row-actions{display:flex;gap:8px;align-items:center;margin:8px 0}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;margin-right:6px;color:#334155;background:#f8fafc}
    .err{color:#b91c1c;background:#fef2f2;border:1px solid #fecaca;padding:8px;border-radius:8px;margin:8px 0;font-size:14px}
    .ok{color:#166534;background:#ecfdf5;border:1px solid #bbf7d0;padding:8px;border-radius:8px;margin:8px 0;font-size:14px}
    .nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px;display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Paciente</h1>

    <div class="grid">
      <!-- Columna izquierda: entrada -->
      <div class="box">
        <h3 style="margin-top:0">Ingresar datos</h3>
        <p class="muted">Seleccione síntomas presentes y su severidad. La lista se carga automáticamente desde la base del administrador.</p>

        <div class="row-actions">
          <button class="btn" id="btnRefresh">Actualizar lista</button>
          <span id="symMeta" class="muted"></span>
        </div>

        <form id="f" onsubmit="return false;">
          <table>
            <thead>
              <tr><th>Síntoma</th><th style="width:90px">Presente</th><th style="width:140px">Severidad</th></tr>
            </thead>
            <tbody id="symRows">
              <tr><td colspan="3" class="muted">Cargando síntomas…</td></tr>
            </tbody>
          </table>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
            <p>
              <strong>Alergias (coma separadas):</strong>
              <input id="allergies" placeholder="alergia_penicilina, alergia_paracetamol">
            </p>
            <p>
              <strong>Enfermedades crónicas (coma separadas):</strong>
              <input id="chronics" placeholder="ulcera_gastrica, prolongacion_qt">
            </p>
          </div>

          <div class="row-actions">
            <button class="btn" id="analyze">Analizar</button>
            <span id="status" class="muted"></span>
          </div>
          <div id="errorBox" style="display:none" class="err"></div>
        </form>
      </div>

      <!-- Columna derecha: resultados -->
      <div class="box">
        <h3 style="margin-top:0">Resultados</h3>
        <div id="resultsWrap" class="muted">Sin resultados aún.</div>
        <canvas id="chart"></canvas>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn" id="savePdf">Descargar PDF</button>
          <button class="btn" id="clearHist">Limpiar historial</button>
        </div>
        <div id="flash" style="display:none" class="ok">Guardado</div>
      </div>
    </div>

    <div class="box" style="margin-top:16px">
      <h3 style="margin-top:0">Historial de esta sesión</h3>
      <div id="history" class="muted">Sin análisis previos.</div>
    </div>

    <p><a href="/">← Volver</a></p>
  </div>

<script>
/* ==========================
   Estado UI
========================== */
let lastSelections = {}; // recuerda checks y severidad entre recargas dinámicas

/* ==========================
   Carga dinámica de síntomas
========================== */
async function fetchSymptoms() {
  // 1) Intento con /api/symptoms (público)
  try {
    const r = await fetch('/api/symptoms', {cache:'no-store'});
    if (r.ok) {
      const j = await r.json();
      if (Array.isArray(j.symptoms)) return j.symptoms;
    }
  } catch(e){}
  // 2) Fallback: /api/admin/snapshot (si está accesible)
  try {
    const r2 = await fetch('/api/admin/snapshot', {cache:'no-store'});
    if (r2.ok) {
      const j2 = await r2.json();
      if (Array.isArray(j2.symptoms)) return j2.symptoms.map(s=>s.id);
    }
  } catch(e){}
  return []; // si todo falla
}

async function loadSymptoms() {
  const meta = document.getElementById('symMeta');
  meta.textContent = 'Cargando…';
  // guarda selección actual antes de redibujar
  document.querySelectorAll('#symRows tr').forEach(tr => {
    const id = tr.dataset?.id; if(!id) return;
    const chk = tr.querySelector('input[type="checkbox"]');
    const sev = tr.querySelector('select');
    lastSelections[id] = { present: chk?.checked || false, severity: sev?.value || 'moderado' };
  });

  const list = (await fetchSymptoms()).slice().sort();
  const tbody = document.getElementById('symRows');
  tbody.innerHTML = '';

  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="3" class="err">No se pudieron cargar síntomas. Verifica que el administrador haya guardado la KB y que el backend expone <code>/api/symptoms</code> o <code>/api/admin/snapshot</code>.</td></tr>`;
    meta.textContent = '';
    return;
  }

  for (const id of list) {
    const sel = lastSelections[id] || { present:false, severity:'moderado' };
    const tr = document.createElement('tr');
    tr.dataset.id = id;
    tr.innerHTML = `
      <td class="nowrap" title="${id}">${id.replace(/_/g,' ')}</td>
      <td style="text-align:center"><input type="checkbox" id="chk-${id}" ${sel.present?'checked':''}></td>
      <td>
        <select id="sev-${id}">
          <option value="leve" ${sel.severity==='leve'?'selected':''}>leve</option>
          <option value="moderado" ${sel.severity==='moderado'?'selected':''}>moderado</option>
          <option value="severo" ${sel.severity==='severo'?'selected':''}>severo</option>
        </select>
      </td>`;
    tbody.appendChild(tr);
  }
  meta.textContent = `${list.length} síntomas disponibles`;
}

/* ==========================
   Armar request y llamar /api/diagnose
========================== */
function collectRequest(){
  const symptoms = [];
  document.querySelectorAll('#symRows tr').forEach(tr=>{
    const id = tr.dataset.id;
    const present = tr.querySelector('input[type="checkbox"]').checked;
    const severity = tr.querySelector('select').value;
    symptoms.push({ id, present, severity });
  });
  const allergies = (document.getElementById('allergies').value||'')
      .split(',').map(s=>s.trim()).filter(Boolean);
  const chronics  = (document.getElementById('chronics').value||'')
      .split(',').map(s=>s.trim()).filter(Boolean);
  return { symptoms, allergies, chronics };
}

async function diagnose(){
  const btn = document.getElementById('analyze');
  const status = document.getElementById('status');
  const err = document.getElementById('errorBox');
  err.style.display='none'; err.textContent='';
  btn.disabled = true; status.textContent = 'Analizando…';

  const payload = collectRequest();
  try{
    const res = await fetch('/api/diagnose', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error(txt || ('HTTP '+res.status));
    }
    const data = await res.json();
    renderResults(data);
    pushHistory(payload, data);
    renderHistory();
  }catch(e){
    err.style.display='block';
    err.textContent = 'Error del servidor: ' + (e.message||e.toString());
  }finally{
    btn.disabled = false; status.textContent = '';
  }
}

/* ==========================
   Render de resultados y gráfica
========================== */
function renderResults(data){
  const w = document.getElementById('resultsWrap');
  if(!data || !Array.isArray(data.diagnoses) || !data.diagnoses.length){
    w.innerHTML = '<div class="muted">Sin coincidencias.</div>';
    drawChart([]);
    return;
  }
  const rows = data.diagnoses.map(d=>`
    <tr>
      <td>
        <strong>${d.disease}</strong><br>
        <span class="muted">Reglas: ${(d.rules_fired||[]).join(', ')}</span><br>
        ${ d.matched_symptoms?.length
          ? `<span class="muted">Match: ${d.matched_symptoms.join(', ')}</span>`
          : '' }
      </td>
      <td>${d.affinity}%</td>
      <td>${d.suggested_drug ? `<span class="pill">${d.suggested_drug}</span>` : '<span class="muted">N/A</span>'}
          ${ (d.alternatives&&d.alternatives.length)
            ? d.alternatives.map(a=>`<span class="pill">${a}</span>`).join(' ')
            : '' }
      </td>
      <td>${d.urgency}</td>
      <td>${(d.warnings||[]).join(' • ')}</td>
    </tr>
  `).join('');

  w.innerHTML = `
    <table>
      <thead><tr><th>Enfermedad</th><th>Afinidad</th><th>Medicamento</th><th>Urgencia</th><th>Advertencias</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    ${ data.explanations ? `<p class="muted" style="margin-top:8px">${data.explanations}</p>` : '' }
  `;
  drawChart(data.diagnoses.slice(0,6));
}

function drawChart(list){
  const c = document.getElementById('chart');
  const ctx = c.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = c.clientWidth || 800, h = 240;
  c.width = Math.round(w*dpr); c.height = Math.round(h*dpr);
  ctx.scale(dpr, dpr);
  ctx.clearRect(0,0,w,h);

  if(!list.length){
    ctx.fillStyle = '#94a3b8';
    ctx.fillText('—', 10, 20);
    return;
  }
  const max = Math.max(...list.map(x=>x.affinity), 1);
  const left = 30, right = 10, bottom = 26, top = 10;
  const innerW = w-left-right, innerH = h-top-bottom;
  const barW = Math.max(24, innerW/list.length - 12);

  ctx.font = '12px system-ui, Arial';
  ctx.fillStyle = '#334155';
  ctx.fillText('% afinidad', 6, 12);

  list.forEach((d,i)=>{
    const x = left + i*(barW+12);
    const bh = Math.round((d.affinity/max)*innerH);
    const y = top + (innerH - bh);
    ctx.fillStyle = '#3b82f6';
    ctx.fillRect(x, y, barW, bh);
    ctx.fillStyle = '#0f172a';
    // etiqueta % arriba
    ctx.fillText(d.affinity+'%', x+2, y-4);
    // nombre abreviado abajo
    const label = (d.disease||'').toString();
    const short = label.length>12 ? label.slice(0,11)+'…' : label;
    ctx.fillText(short, x, h-8);
  });
}

/* ==========================
   Historial en sessionStorage
========================== */
function pushHistory(req, resp){
  const item = { at: new Date().toISOString(), req, resp };
  const arr = JSON.parse(sessionStorage.getItem('hist')||'[]');
  arr.unshift(item);
  sessionStorage.setItem('hist', JSON.stringify(arr.slice(0,10)));
}
function renderHistory(){
  const box = document.getElementById('history');
  const arr = JSON.parse(sessionStorage.getItem('hist')||'[]');
  if(!arr.length){ box.textContent = 'Sin análisis previos.'; return; }
  box.innerHTML = arr.map(it=>{
    const top = (it.resp?.diagnoses||[])[0];
    const sum = top ? (top.disease + ' — ' + top.affinity + '%') : 'Sin resultado';
    const when = new Date(it.at).toLocaleString();
    return `<div class="muted">• ${when} → ${sum}</div>`;
  }).join('');
}

/* ==========================
   PDF simple
========================== */
function savePdf(){
  const w = window.open('', '_blank', 'width=900,height=700');
  w.document.write('<html><head><title>Informe</title><style>body{font-family:Arial;padding:16px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ddd;padding:6px} .muted{color:#666;font-size:12px}</style></head><body>');
  w.document.write('<h2>Informe de Diagnóstico</h2>');
  w.document.write('<div>'+ document.getElementById('resultsWrap').innerHTML +'</div>');
  w.document.write('<p class="muted">Generado: '+ new Date().toLocaleString() +'</p>');
  w.document.write('</body></html>');
  w.document.close(); w.focus(); w.print();
}

/* ==========================
   Hooks
========================== */
document.addEventListener('DOMContentLoaded', async ()=>{
  await loadSymptoms();
  renderHistory();
});
document.getElementById('btnRefresh').addEventListener('click', loadSymptoms);
document.getElementById('analyze').addEventListener('click', diagnose);
document.getElementById('clearHist').addEventListener('click', ()=>{ sessionStorage.removeItem('hist'); renderHistory(); });
document.getElementById('savePdf').addEventListener('click', savePdf);
</script>
</body>
</html>
